#!/bin/sh

VIDEO_FILE=$1
OUTPUT_DIR=$2
RESOLUTION=$3

DIR=`dirname $BASH_SOURCE[0]`
TMP_DIR="${DIR}/../tmp"
# TRANSPORT_STREAM_DIR="${TMP_DIR}/uploads/${DIR_ID}"
TRANSPORT_STREAM_DIR=$OUTPUT_DIR
FRAMERATE="$(./bin/get_framerate $VIDEO_FILE)"

echo "---> DIR Output: $2"

echo "---> Creating a ts directory at ${TRANSPORT_STREAM_DIR}"
mkdir -p $TRANSPORT_STREAM_DIR

echo "---> Creating sequences for $VIDEO_FILE at ${FRAMERATE}fps"
./bin/ffmpeg -y -i $VIDEO_FILE  -c:a aac \
  -strict experimental -ac 2 -b:a 64k -ar 44100 -c:v libx264 -pix_fmt yuv420p \
  -profile:v baseline -level 1.3 -maxrate 192K -bufsize 1M -crf 18 \
  -r $FRAMERATE -g 30 -f hls -hls_time 9 -hls_list_size 0 -s $RESOLUTION \
  "${TRANSPORT_STREAM_DIR}/playlist_${RESOLUTION}.m3u8"
