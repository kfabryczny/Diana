#!/bin/sh

DIR=`dirname $BASH_SOURCE[0]`
TMP_DIR="${DIR}/../tmp"
DIR_ID=`uuidgen`
TRANSPORT_STREAM_DIR="${TMP_DIR}/uploads/${DIR_ID}"
VIDEO_FILE=$1
RESOLUTION=$2
FRAMERATE="$($DIR/get_framerate $VIDEO_FILE)"

echo "---> Creating a ts directory at ${TRANSPORT_STREAM_DIR}"
mkdir -p $TRANSPORT_STREAM_DIR

echo "---> Creating sequences for $VIDEO_FILE at ${FRAMERATE}fps"
ffmpeg -y -i $VIDEO_FILE  -c:a aac \
  -strict experimental -ac 2 -b:a 64k -ar 44100 -c:v libx264 -pix_fmt yuv420p \
  -profile:v baseline -level 1.3 -maxrate 192K -bufsize 1M -crf 18 \
  -r $FRAMERATE -g 30 -f hls -hls_time 9 -hls_list_size 0 -s $RESOLUTION \
  "${TRANSPORT_STREAM_DIR}/320x180.m3u8"
